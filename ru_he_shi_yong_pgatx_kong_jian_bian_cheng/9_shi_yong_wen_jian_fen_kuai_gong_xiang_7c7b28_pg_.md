## 9\. 使用文件分块共享类(PG_CLASS_Share) {#9-pg-class-share}

### 1) 顺序传输模式 {#1}

顺序传输模式是缺省的传输模式。使用该模式时，系统优先按照从前到后的顺序获取数据块。只有当某个数据块还没有源时，才跳到后面获取已经有源的数据块。这种模式的用途是传输媒体流文件，按照从前到后的顺序获取数据块有利于媒体流文件一边下载一边播放。

### 2) 分散传输模式 {#2}

分散传输模式用PG_ADD_SHARE_Distribute选项开启。与顺序传输模式相反，分散传输模式尽力避免按照从前到后的顺序传输数据块。这种模式的用途是尽量保持参与共享的节点以相同的进度获取文件，避免某些节点过早传输完成后就关闭了共享。

### 3) 文件的存储和种子 {#3}

调用PG_METH_SHARE_Open 方法打开文件分块共享对象时，系统先检查指定的本地存储路径下是否存在该文件。如果文件不存在，则系统创建两个文件分别用来存储文件数据块和传输的状态。这两个文件的文件名分别为共享文件名加上后缀“.pgshs”和“.pgshi”。文件传输完成后系统把“.pgshi”文件删除，把“.pgshs”重命名为共享文件名。例如，假设共享的文件名为“xxxx.avi”，则系统创建的两个文件名分别为“xxxx.avi.pgshs”和“xxxx.avi.pgshi”，传输完成后系统把“xxxx.avi.pgshi”删除，把“xxxx.avi.pgshs”重命名为“xxxx.avi”。

某个节点获取到所有的文件数据块后，作为种子给其他节点继续共享文件。

### 4) 转发到本地HTTP服务器 {#4-http}

控件提供了本地HTTP服务器功能，可以在节点本地的私网地址或环回地址上启动一个HTTP服务器，允许HTTP客户端在本地通过HTTP方式访问Peergine的内容。文件分块共享类能够把正在传输的文件数据实时转发到本地HTTP服务器上，提供给HTTP客户端访问。

使用HttpConfig命令启动本地HTTP服务器，请参考“[控件的命令列表](..\jie_dian_gong_neng_lei_de_bian_cheng_can_80033a\11_pgclasslive_7c7b3a.md#5)”章节。调用PG_METH_SHARE_Open方法打开文件分块共享对象时，如果指定了HttpURL参数，则该文件分块共享对象在本地HTTP服务器上建立一个转发关联。当获取到数据块时，会实时转发到本地HTTP服务器上。HTTP客户端可以使用HttpURL参数指定的URL从HTTP服务器下载共享文件。

这个功能的用途是方便实现媒体流文件的一边下载一边播放。使用顺序传输模式获取媒体流文件并实时转发到本地HTTP服务器上，然后使用具有网络播放功能的播放器播放该媒体流文件的URL。